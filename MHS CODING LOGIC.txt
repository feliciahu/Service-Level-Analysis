USE ROLE SBX_EA_GENERAL_FR;
USE DATABASE SBX_PSAS_DB;
USE SCHEMA ANALYTICS;
USE WAREHOUSE SBX_EA_GENERAL_FR_WH;


CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_CPH (
DATE DATE,
BUSINESS_SEGMENT VARCHAR(99),
CHAIN_GPO VARCHAR(99),
REP_NAME VARCHAR(99),
PREVIOUS_WHOLESALER VARCHAR(99),
CUSTOMER_NAME VARCHAR(99),
OS VARCHAR(99),
START_DATE_NOTED VARCHAR(99),
START_DATE_ACTUAL DATE,
CUST_ACCT_ID VARCHAR(99),
ESTIMATED_ANNUAL_VOLUME INT,
ESTIMATED_WEEKLY_VOLUME INT,
BUILD VARCHAR(99),
NO_BUILD_REASON VARCHAR(99),
HOME_DC_ID VARCHAR(99),
SL_FREQUENCY VARCHAR(99),
PROVIDED_USAGE_TIME_FRAME VARCHAR(99),
ACCOUNT_MANAGER_NAME VARCHAR(99),
POINT_PERSON_NAME VARCHAR(99),
HOLDOUT_REF_ID VARCHAR(99),
STATUS VARCHAR(99),
NEXT_CHANGE_DATE VARCHAR(99),
NOTES VARCHAR(399),
DATE_TRANSITIONED_TO_ANALYST DATE,
ANALYST_NAME VARCHAR(99),
RAW_SL_AVG DECIMAL(8,4),
ADJ_SL_AVG DECIMAL(8,4),
ACTUAL_WEEKLY_VOLUME INT,
ANNUALIZED_VOLUME INT,
ANNUAL_EST INT,
VARIANCE DECIMAL(8,4),
EXPECTED_VOLUME_PERCENT DECIMAL(8,4),
VOL_CATEGORY VARCHAR(99),
START_DATE_CATEGORY VARCHAR(99),
DATE_GAP INT,
POST_TRANS_REVIEW DATE,
SERVICE_LEVEL_CODING_CHAIN_ID VARCHAR(99),
SERVICE_LEVEL_CODING_NATIONAL_GROUP_ID VARCHAR(99),
SERVICE_LEVEL_CODING_NATIONAL_SUB_GROUP_ID VARCHAR(99),
SERVICE_LEVEL_CODING_REGION_ID VARCHAR(99),
SERVICE_LEVEL_CODING_ACCOUNT_ID VARCHAR(699),
TOTAL_BUILD_DOLLAR_VALUE INT,
PERCENT_OF_ANNUAL_EST DECIMAL(8,4),
BUILD_STRATEGY_INVENTORY_BUILD_DAYS VARCHAR(99),
ITEMS_WITH_MONTHLY_FORECAST_EXCLUDED VARCHAR(99),
GO_LIVE_REF VARCHAR(99),
OH_MCNS_COVERAGE_TARGET90 DECIMAL(8,4),
OH_OO_MUS_COVERAGE_TARGET96 DECIMAL(8,4)
);

CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS (
DATE DATE,
BUSINESS_SEGMENT VARCHAR(99),
CHAIN_GPO VARCHAR(99),
REP_NAME VARCHAR(99),
PREVIOUS_WHOLESALER VARCHAR(99),
CUSTOMER_NAME VARCHAR(99),
OS VARCHAR(99),
START_DATE_NOTED VARCHAR(99),
START_DATE_ACTUAL DATE,
CUST_ACCT_ID VARCHAR(99),
ESTIMATED_ANNUAL_VOLUME INT,
ESTIMATED_WEEKLY_VOLUME INT,
BUILD VARCHAR(99),
NO_BUILD_REASON VARCHAR(99),
HOME_DC_ID VARCHAR(99),
SL_FREQUENCY VARCHAR(99),
PROVIDED_USAGE_TIME_FRAME VARCHAR(99),
ACCOUNT_MANAGER_NAME VARCHAR(99),
POINT_PERSON_NAME VARCHAR(99),
HOLDOUT_REF_ID VARCHAR(99),
STATUS VARCHAR(99),
NEXT_CHANGE_DATE VARCHAR(99),
NOTES VARCHAR(399),
DATE_TRANSITIONED_TO_ANALYST DATE,
ANALYST_NAME VARCHAR(99),
RAW_SL_AVG DECIMAL(8,4),
ADJ_SL_AVG DECIMAL(8,4),
ACTUAL_WEEKLY_VOLUME INT,
ANNUALIZED_VOLUME INT,
ANNUAL_EST INT,
VARIANCE DECIMAL(8,4),
EXPECTED_VOLUME_PERCENT DECIMAL(8,4),
VOL_CATEGORY VARCHAR(99),
START_DATE_CATEGORY VARCHAR(99),
DATE_GAP INT,
POST_TRANS_REVIEW DATE,
SERVICE_LEVEL_CODING_CHAIN_ID VARCHAR(99),
SERVICE_LEVEL_CODING_NATIONAL_GROUP_ID VARCHAR(99),
SERVICE_LEVEL_CODING_NATIONAL_SUB_GROUP_ID VARCHAR(99),
SERVICE_LEVEL_CODING_REGION_ID VARCHAR(99),
SERVICE_LEVEL_CODING_ACCOUNT_ID VARCHAR(699),
TOTAL_BUILD_DOLLAR_VALUE INT,
PERCENT_OF_ANNUAL_EST DECIMAL(8,4),
BUILD_STRATEGY_INVENTORY_BUILD_DAYS VARCHAR(99),
ITEMS_WITH_MONTHLY_FORECAST_EXCLUDED VARCHAR(99),
GO_LIVE_REF VARCHAR(99),
OH_MCNS_COVERAGE_TARGET90 DECIMAL(8,4),
OH_OO_MUS_COVERAGE_TARGET96 DECIMAL(8,4)
);

--SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS;
--SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_CPH;

--MHS CODING LOGIC
CREATE OR REPLACE TABLE ACCT AS
SELECT  CUSTOMER_NAME, VALUE AS CUST_ACCT_ID,
FROM    SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS, LATERAL SPLIT_TO_TABLE(SERVICE_LEVEL_CODING_ACCOUNT_ID, ';')
WHERE   SERVICE_LEVEL_CODING_ACCOUNT_ID IS NOT NULL;

CREATE OR REPLACE TABLE REGION_ID AS
SELECT  CUSTOMER_NAME, VALUE AS REGION_ID 
FROM    SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS, LATERAL SPLIT_TO_TABLE(SERVICE_LEVEL_CODING_REGION_ID, ';')
WHERE   SERVICE_LEVEL_CODING_REGION_ID IS NOT NULL
AND SERVICE_LEVEL_CODING_ACCOUNT_ID IS NULL;

CREATE OR REPLACE TABLE NATL_SUB_GROUP_ID AS
SELECT  CUSTOMER_NAME, VALUE AS NATL_SUB_GROUP_ID
FROM    SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS, LATERAL SPLIT_TO_TABLE(SERVICE_LEVEL_CODING_NATIONAL_SUB_GROUP_ID, ';')
WHERE   SERVICE_LEVEL_CODING_NATIONAL_SUB_GROUP_ID IS NOT NULL
AND SERVICE_LEVEL_CODING_ACCOUNT_ID IS NULL;

CREATE OR REPLACE TABLE NATL_GROUP_ID AS
SELECT  CUSTOMER_NAME, VALUE AS NATL_GROUP_ID
FROM    SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS, LATERAL SPLIT_TO_TABLE(SERVICE_LEVEL_CODING_NATIONAL_GROUP_ID, ';')
WHERE   SERVICE_LEVEL_CODING_NATIONAL_GROUP_ID IS NOT NULL
AND SERVICE_LEVEL_CODING_ACCOUNT_ID IS NULL;

CREATE OR REPLACE TABLE CHAIN_ID AS
SELECT  CUSTOMER_NAME, VALUE AS CHAIN_ID
FROM    SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS, LATERAL SPLIT_TO_TABLE(SERVICE_LEVEL_CODING_CHAIN_ID, ';')
WHERE   SERVICE_LEVEL_CODING_CHAIN_ID IS NOT NULL
AND SERVICE_LEVEL_CODING_ACCOUNT_ID IS NULL;

CREATE OR REPLACE TABLE MAPPING AS 
SELECT 
A.CUSTOMER_NAME,
A.CHAIN_ID,
B.NATL_GROUP_ID,
C.NATL_SUB_GROUP_ID,
D.REGION_ID
FROM CHAIN_ID A
LEFT JOIN NATL_GROUP_ID B
ON A.CUSTOMER_NAME=B.CUSTOMER_NAME
LEFT JOIN NATL_SUB_GROUP_ID C
ON A.CUSTOMER_NAME=C.CUSTOMER_NAME
LEFT JOIN REGION_ID D
ON A.CUSTOMER_NAME=D.CUSTOMER_NAME;

CREATE OR REPLACE TABLE ACCT_NO_REGION AS 
SELECT MAPPING.*,
ACCT.CUST_ACCT_ID
FROM MAPPING MAPPING
LEFT JOIN PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR ACCT
ON LTRIM(MAPPING.CHAIN_ID,'0')=LTRIM(ACCT.ACCT_CHN_ID,'0')
AND LTRIM(MAPPING.NATL_GROUP_ID,'0')=LTRIM(ACCT.NATL_GRP_CD,'0')
AND LTRIM(MAPPING.NATL_SUB_GROUP_ID,'0')=LTRIM(ACCT.NATL_SUB_GRP_CD,'0')
WHERE MAPPING.REGION_ID IS NULL;

CREATE OR REPLACE TABLE ACCT_YES_REGION AS 
SELECT MAPPING.*,
ACCT.CUST_ACCT_ID
FROM MAPPING MAPPING
LEFT JOIN PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR ACCT
ON LTRIM(MAPPING.CHAIN_ID,'0')=LTRIM(ACCT.ACCT_CHN_ID,'0')
AND LTRIM(MAPPING.NATL_GROUP_ID,'0')=LTRIM(ACCT.NATL_GRP_CD,'0')
AND LTRIM(MAPPING.NATL_SUB_GROUP_ID,'0')=LTRIM(ACCT.NATL_SUB_GRP_CD,'0')
AND LTRIM(MAPPING.REGION_ID,'0')=LTRIM(ACCT.CUST_RGN_NUM,'0')
WHERE REGION_ID IS NOT NULL;

CREATE OR REPLACE TABLE FINAL AS 
SELECT DISTINCT CUSTOMER_NAME,CUST_ACCT_ID
FROM ACCT
WHERE CUST_ACCT_ID <> ''
GROUP BY 1,2
UNION 
SELECT DISTINCT CUSTOMER_NAME,CUST_ACCT_ID 
FROM ACCT_NO_REGION
WHERE CUST_ACCT_ID <> ''
GROUP BY 1,2
UNION 
SELECT DISTINCT CUSTOMER_NAME,CUST_ACCT_ID 
FROM ACCT_YES_REGION
WHERE CUST_ACCT_ID <> ''
GROUP BY 1,2;

-- SELECT * FROM FINAL WHERE CUST_ACCT_ID='119682';

-- SELECT * FROM PRD_PSAS_DB.EDWRPT.DIM_CUST_ACCT_CURR
-- WHERE CUST_ACCT_NAM LIKE '%SPRINGHILL MEDICAL CENTER%'
-- WHERE CUST_ACCT_ID='171311'
-- LTRIM(ACCT_CHN_ID,'0')='660'
-- AND LTRIM(NATL_GRP_CD,'0')='230'
-- AND LTRIM(NATL_SUB_GRP_CD,'0')='400'
-- AND LTRIM(CUST_RGN_NUM,'0')='80'


--SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.SERVICE_LEVEL_INPUT_MHS WHERE CUSTOMER_NAME='WEST VIRGINIA UNIVERSITY';